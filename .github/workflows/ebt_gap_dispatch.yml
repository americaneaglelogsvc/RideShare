name: EBT Gap Dispatch (RideShare)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python deps (if requirements.txt exists)
        shell: bash
        run: |
          if [ -f requirements.txt ]; then
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
          else
            echo "requirements.txt not found; skipping pip install"
          fi

      - name: Build Requirements/requirements.jsonl from CANONICAL.md
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $in  = "Requirements/CANONICAL.md"
          $out = "Requirements/requirements.jsonl"
          if (-not (Test-Path $in))  { throw "Missing $in" }
          if (-not (Test-Path "scripts/extract_requirements_jsonl.ps1")) { throw "Missing scripts/extract_requirements_jsonl.ps1" }

          pwsh -NoProfile -File "scripts/extract_requirements_jsonl.ps1" -InputMd $in -OutputJsonl $out

          if (-not (Test-Path $out)) { throw "requirements.jsonl was not created at $out" }

      - name: Run gap report generator (capture log)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $script = "scripts/generate_gap_report.ps1"
          if (-not (Test-Path $script)) {
            "Missing $script" | Tee-Object -FilePath gap_dispatch_generator.log
            exit 1
          }
          "Using script: $script" | Tee-Object -FilePath gap_dispatch_generator.log
          & pwsh -NoProfile -File $script *>&1 | Tee-Object -FilePath gap_dispatch_generator.log -Append
          $code = $LASTEXITCODE
          "EXITCODE=$code" | Tee-Object -FilePath gap_dispatch_generator.log -Append
          exit $code

      - name: Upload gap artifact + debug (ALWAYS)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ebt_gap_report
          path: |
            gap_dispatch_generator.log
            Requirements/requirements.jsonl
            AgentOutput/**
            Artifacts/**
            out/**
            **/*gap*report*
          if-no-files-found: warn